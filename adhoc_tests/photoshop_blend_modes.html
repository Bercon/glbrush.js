<html>
<head>
<!-- Copyright Jerry Ylilammi 2013 -->
<title>Photoshop blend mode comparison</title>
<script type="text/javascript" src="../util2d.js"></script>
<script type="text/javascript" src="../utilgl.js"></script>
<script type="text/javascript" src="../blit_shader.js"></script>
<script type="text/javascript" src="../rasterize_shader.js"></script>
<script type="text/javascript" src="../gradient_shader.js"></script>
<script type="text/javascript" src="../compositing_shader.js"></script>
<script type="text/javascript" src="../compositor.js"></script>
<script type="text/javascript" src="../picture_event.js"></script>
<script type="text/javascript" src="../rasterize.js"></script>
<script type="text/javascript" src="../picture_buffer.js"></script>
<script type="text/javascript" src="../undo_state.js"></script>
<script type="text/javascript" src="../picture.js"></script>
<script type="text/javascript">

// Generate input values, these are the same values used in Photoshop layers, input1.png and input2.png
var inputs = [];
for (var i = 0; i < 26; i++) {
    inputs.push(i * 10);
}
inputs.push(255);

// Compare blendFunction with reference data from Photoshop CS5, the reference data was generated with input1.png as
// base layer and input2.png on top with 100% opacity and given blend mode selected.
function testBlendFunction(name, blendFunction) {
    var img = new Image();
    img.onload = function () {
        var canvas = document.createElement("canvas");
        canvas.width = 27;
        canvas.height = 27;
        var ctx = canvas.getContext("2d");
        ctx.drawImage(this, 0, 0);
        var data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        var error = 0.;
        for (var x = 0; x < 27; x++)
            for (var y = 0; y < 27; y++) {
                var result = blendFunction(inputs[x], inputs[y]);
                error += Math.abs(data[(x + y*27) * 4] - result);
                //console.log("func " + result + " vs. ps " + data[(x + y*27) * 4]);
            }
        var averageError = error / (27 * 27) * (100 / 255)
        document.body.innerHTML += "<div>Testing function <b>" + name + "</b>, average error is <b>" + averageError +
                " %<b></div>";
    }        
    img.src = "img/photoshop_cs5_" + name + ".png";
}

function runTest() {
    testBlendFunction("multiply", function(a,b) { return a * (b / 255); });
}

</script>
</head>
<body onload="runTest()" style="background:#DDD;">
</body>
</html>